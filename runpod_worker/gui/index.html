<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharForgex RunPod Worker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">CharForgex RunPod Worker</h1>
            <p class="text-gray-600">AI-Powered Character LoRA Creation & Inference</p>
            
            <!-- Status Bar -->
            <div class="mt-4 flex items-center space-x-4">
                <div class="flex items-center">
                    <div :class="['w-3 h-3 rounded-full mr-2', workerStatus === 'online' ? 'bg-green-500' : 'bg-red-500']"></div>
                    <span class="text-sm font-medium">Worker: {{ workerStatus }}</span>
                </div>
                <div class="text-sm text-gray-500">
                    Endpoint: {{ endpointUrl || 'Not configured' }}
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Configuration</h2>

            <!-- API Mode Toggle -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input
                        v-model="useLocalAPI"
                        type="checkbox"
                        class="mr-2"
                        @change="localStorage.setItem('useLocalAPI', useLocalAPI)"
                    >
                    <span class="text-sm font-medium text-gray-700">Use Local API (for testing)</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">
                    Check this when running the web server locally for testing
                </p>
            </div>

            <div v-if="!useLocalAPI" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">RunPod Endpoint URL</label>
                    <input
                        v-model="endpointUrl"
                        type="text"
                        placeholder="https://api.runpod.ai/v2/YOUR_ENDPOINT_ID/runsync"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input 
                        v-model="apiKey" 
                        type="password" 
                        placeholder="Your RunPod API Key"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
            </div>

            <div v-else class="bg-blue-50 border border-blue-200 rounded-md p-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <span class="text-sm font-medium text-blue-800">Local API Mode</span>
                </div>
                <p class="text-xs text-blue-600 mt-1">
                    Using local web server API endpoints. No RunPod configuration needed.
                </p>
            </div>

            <button
                @click="testConnection"
                :disabled="loading || (!useLocalAPI && (!endpointUrl || !apiKey))"
                class="mt-4 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-md transition-colors"
            >
                <span v-if="loading" class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                Test Connection
            </button>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button 
                        v-for="tab in tabs" 
                        :key="tab.id"
                        @click="activeTab = tab.id"
                        :class="['py-4 px-1 border-b-2 font-medium text-sm transition-colors', 
                                activeTab === tab.id 
                                    ? 'border-blue-500 text-blue-600' 
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300']"
                    >
                        {{ tab.name }}
                    </button>
                </nav>
            </div>

            <!-- Training Tab -->
            <div v-show="activeTab === 'training'" class="p-6">
                <h3 class="text-lg font-semibold mb-4">Train Character LoRA</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Character Name</label>
                        <input 
                            v-model="training.characterName" 
                            type="text" 
                            placeholder="Enter character name"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reference Image</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input 
                                type="file" 
                                @change="handleImageUpload" 
                                accept="image/*" 
                                class="hidden" 
                                ref="imageInput"
                            >
                            <div v-if="!training.imagePreview" @click="$refs.imageInput.click()" class="cursor-pointer">
                                <div class="text-gray-400 mb-2">
                                    <svg class="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <p class="text-sm text-gray-600">Click to upload reference image</p>
                            </div>
                            <div v-else class="relative">
                                <img :src="training.imagePreview" class="max-h-48 mx-auto rounded-lg">
                                <button 
                                    @click="clearImage" 
                                    class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                >
                                    ×
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Training Parameters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Training Steps</label>
                            <input 
                                v-model.number="training.steps" 
                                type="number" 
                                min="100" 
                                max="2000"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Learning Rate</label>
                            <select 
                                v-model="training.learningRate" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="8e-4">8e-4 (Default)</option>
                                <option value="1e-4">1e-4 (Conservative)</option>
                                <option value="5e-4">5e-4 (Moderate)</option>
                                <option value="1e-3">1e-3 (Aggressive)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Rank</label>
                            <select 
                                v-model.number="training.rankDim" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="4">4 (Fast)</option>
                                <option value="8">8 (Default)</option>
                                <option value="16">16 (High Quality)</option>
                                <option value="32">32 (Maximum)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button 
                        @click="startTraining" 
                        :disabled="!canStartTraining || loading"
                        class="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white py-3 px-4 rounded-md font-medium transition-colors"
                    >
                        <span v-if="loading" class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        {{ loading ? 'Training in Progress...' : 'Start Training' }}
                    </button>
                </div>
            </div>

            <!-- Inference Tab -->
            <div v-show="activeTab === 'inference'" class="p-6">
                <h3 class="text-lg font-semibold mb-4">Generate Images</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Character</label>
                        <select 
                            v-model="inference.characterName" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Select a character...</option>
                            <option v-for="character in availableCharacters" :key="character" :value="character">
                                {{ character }}
                            </option>
                        </select>
                        <button 
                            @click="loadCharacters" 
                            class="mt-2 text-sm text-blue-500 hover:text-blue-600"
                        >
                            Refresh Characters
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prompt</label>
                        <textarea 
                            v-model="inference.prompt" 
                            rows="3" 
                            placeholder="Describe the image you want to generate..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        ></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Weight</label>
                            <input 
                                v-model.number="inference.loraWeight" 
                                type="number" 
                                min="0.1" 
                                max="2.0" 
                                step="0.1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image Size</label>
                            <select 
                                v-model.number="inference.imageSize" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="512">512x512</option>
                                <option value="768">768x768</option>
                                <option value="1024">1024x1024</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Steps</label>
                            <input 
                                v-model.number="inference.steps" 
                                type="number" 
                                min="10" 
                                max="50"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch Size</label>
                            <select 
                                v-model.number="inference.batchSize" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="1">1 Image</option>
                                <option value="2">2 Images</option>
                                <option value="4">4 Images</option>
                            </select>
                        </div>
                    </div>
                    
                    <button 
                        @click="generateImages" 
                        :disabled="!canGenerate || loading"
                        class="w-full bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 text-white py-3 px-4 rounded-md font-medium transition-colors"
                    >
                        <span v-if="loading" class="loading inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        {{ loading ? 'Generating...' : 'Generate Images' }}
                    </button>
                </div>
                
                <!-- Generated Images -->
                <div v-if="generatedImages.length > 0" class="mt-8">
                    <h4 class="text-lg font-semibold mb-4">Generated Images</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div v-for="(image, index) in generatedImages" :key="index" class="relative group">
                            <img :src="'data:image/jpeg;base64,' + image.image_data" class="w-full rounded-lg shadow-md">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all rounded-lg flex items-center justify-center">
                                <button 
                                    @click="downloadImage(image, index)" 
                                    class="opacity-0 group-hover:opacity-100 bg-white text-gray-800 px-3 py-1 rounded-md text-sm font-medium transition-opacity"
                                >
                                    Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Characters Tab -->
            <div v-show="activeTab === 'characters'" class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Trained Characters</h3>
                    <button 
                        @click="loadCharacters" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm"
                    >
                        Refresh
                    </button>
                </div>
                
                <div v-if="availableCharacters.length === 0" class="text-center py-8 text-gray-500">
                    <p>No trained characters found.</p>
                    <p class="text-sm mt-2">Train your first character in the Training tab.</p>
                </div>
                
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="character in availableCharacters" :key="character" class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-800 mb-2">{{ character }}</h4>
                        <p class="text-sm text-gray-600 mb-3">LoRA model trained and ready</p>
                        <button 
                            @click="selectCharacterForInference(character)" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md text-sm transition-colors"
                        >
                            Use for Inference
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div v-if="statusMessage" class="fixed bottom-4 right-4 max-w-sm">
            <div :class="['p-4 rounded-lg shadow-lg fade-in', 
                         statusMessage.type === 'success' ? 'bg-green-500 text-white' : 
                         statusMessage.type === 'error' ? 'bg-red-500 text-white' : 
                         'bg-blue-500 text-white']">
                <div class="flex justify-between items-start">
                    <p class="text-sm">{{ statusMessage.text }}</p>
                    <button @click="statusMessage = null" class="ml-2 text-white hover:text-gray-200">×</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
